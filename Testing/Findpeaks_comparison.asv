clc;
clear all;

folder = 'Full_test';
list = dir('*.csv')
ctr = 0;
Errs = 0;

tmp = struct2cell(list);
names = tmp(1,:);
attrList = cellfun(@getAttr,names);
attrList = filterby(attrList,'countable','True');
attrList = filterby(attrList,'ambient','24');
attrList = filterby(attrList,'depth','D');

%attrList = filterby(attrList,'name','J');

for i=1:length(attrList)
    attrs = attrList(i);
   

    if(list(i).isdir==1 || ~isempty(strfind(list(i).name,'speaker')))
        continue;
    end
    
    ctr=ctr+1;
    x = csvread(list(i).name);


    sig = x(:,2).';
    time = x(:,end).'/1000;
    
    
    
    [tResamp,sigResamp] = interper(time,sig,40);
    
    tunedDets = gradDetector(tResamp,sigResamp,0.05);
    figure();
    

    split = 5;
    
    sigReshaped = reshape(sigResamp,[],split);
    tReshaped = reshape(tResamp,[],split);
    
    Ts = tResamp(2)-tResamp(1);
    Fs = 1/Ts;
    
    for j = 1 : split
    
    L = length(sigReshaped(:,j));
    Y = fft(sigReshaped(:,j));
    f = Fs*(0:(L/2))/L;
    P2 = abs(Y/L);
    P1 = P2(1:L/2+1);
    P1(2:end-1) = 2*P1(2:end-1);
    
    [val,I] = max(P1(2:end));

    tStart = tReshaped(1,j);
    tEnd = tReshaped(end,j);
    
    includedTimePts = and(time>= tStart , time<tEnd);
    RRpts = x(:,4).';
    RRpts = RRpts(includedTimePts);
    
    avgRR = mean(RRpts(RRpts>0));
    
    txt = strcat('tStart  = ',num2str(2),' tEnd = 'm num2str(2),'/n FFT = ', num2str(5),' AVG RR  = ',num2str(avgRR));
    text(f(I)*60,val,txt) 
    
    subplot(3,split,j);
    hold on;
    plot(f(2:end)*60,P1(2:end)) ;
    plot(f(I)*60,val,'r^','markerfacecolor',[1 0 0])
    hold off;
    xlim([0 200]);
    
    %ylim('auto');
    end
    
    subplot(3,split,[split+1, 2*split]);
    plot(time,x(:,4).');

    
    
    detsWStamps=x;

    [~,idu] = unique(detsWStamps(:,3));
    uniqueDetVals = detsWStamps(idu,:);
    uniqueDetVals = uniqueDetVals(2:end,:);
    
    minDist = 0;
    
    if(strcmp(attrs.depth,'S'))
        minDist = 2;
    elseif (strcmp(attrs.depth,'D'))
        minDist = 0;
          
    else
        minDist = 5;
    end
    
    [pk,lk] = findpeaks(sig,'MinPeakDistance',minDist);
    subplot(3,split,[2*split+1, 3*split]);

    hold on;
    plot(time,sig);
    plot(uniqueDetVals(:,5).'/1000,uniqueDetVals(:,2).','*')
    plot(tunedDets(:,1).',tunedDets(:,2).','^')
    plot(time(lk),pk,'o')

    hold off;

    Errs= Errs + 100*abs(length(pk)-length(tunedDets(:,2).'))/length(pk)

end
Errs/ctr

function out = getAttr(name)

res.name = '';
res.ambient = '';
res.depth = '';
res.rate = '';
res.mask =  '';
res.interrupted = '';
res.orifice = '';

res.countable = 'False';

strs = strsplit(name(1:end-4),'-');

res.name = strs(1);

if length(strs)== 7
    res.ambient = strs(2);
    res.depth = strs(3);
    res.rate = strs(4);
    res.mask = strs(5);
    res.interrupted = strs(6);
    res.orifice = strs(7);
    res.countable = 'True';

end

if length(strs)== 5
    res.ambient = strs(2);
    res.depth = strs(3);
    res.rate = '';
    res.mask = strs(4);
    res.orifice = strs(5);
    res.countable = 'True';
end

out = res;
end

function arr = filterby(arr,cat,val)

bools = logical(zeros(1,length(arr)));
for i = 1:length(arr)
    bools(i)=strcmp(arr(i).(cat),val);
end
arr = arr(bools);
end